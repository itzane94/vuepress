<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>php session 的GC机制 | zane&#39;s blog</title>
    <meta name="description" content="php session 的GC机制">
    <link rel="icon" href="/favicon.ico">
    <meta name="keywords" content="php session 的GC机制">
    <link rel="preload" href="/assets/css/0.styles.9c18e3b9.css" as="style"><link rel="preload" href="/assets/js/app.5f87c6e8.js" as="script"><link rel="preload" href="/assets/js/13.2935f7b1.js" as="script"><link rel="prefetch" href="/assets/js/8.85014434.js"><link rel="prefetch" href="/assets/js/2.6fc8154e.js"><link rel="prefetch" href="/assets/js/3.07762fc5.js"><link rel="prefetch" href="/assets/js/4.71579af1.js"><link rel="prefetch" href="/assets/js/5.0a635dda.js"><link rel="prefetch" href="/assets/js/6.1742b4bc.js"><link rel="prefetch" href="/assets/js/7.484365db.js"><link rel="prefetch" href="/assets/js/9.aa5a49dd.js"><link rel="prefetch" href="/assets/js/10.45a59d6f.js"><link rel="prefetch" href="/assets/js/11.7131e4cf.js"><link rel="prefetch" href="/assets/js/12.2032e30a.js"><link rel="prefetch" href="/assets/js/14.06bc1268.js"><link rel="prefetch" href="/assets/js/15.932d2cc6.js"><link rel="prefetch" href="/assets/js/16.d34d6734.js"><link rel="prefetch" href="/assets/js/17.3532124f.js"><link rel="prefetch" href="/assets/js/18.e9142654.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9c18e3b9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="wrap"><div class="theme-container container no-sidebar"><header class="navbar"><div class="nav-header"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" class="logo"> <span class="site-name can-hide">
        zane's blog
      </span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">BLOG</a></div><div class="nav-item"><a href="/tags/" class="nav-link">TAGS</a></div><div class="nav-item"><a href="https://github.com/itzane94" target="_blank" rel="noopener noreferrer" class="nav-link">GITHUB</a></div><div class="nav-item"><a href="https://music.163.com/#/user/home?id=300577130" target="_blank" rel="noopener noreferrer" class="nav-link">网易云</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于我</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">BLOG</a></div><div class="nav-item"><a href="/tags/" class="nav-link">TAGS</a></div><div class="nav-item"><a href="https://github.com/itzane94" target="_blank" rel="noopener noreferrer" class="nav-link">GITHUB</a></div><div class="nav-item"><a href="https://music.163.com/#/user/home?id=300577130" target="_blank" rel="noopener noreferrer" class="nav-link">网易云</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于我</a></div> <!----></nav> <!----></div> <div class="page-container"><div><div class="page card"><div class="content-header"><h1 class="page-title" style="color:#ac3e40;">
        php session 的GC机制
      </h1> <span class="page-timestamp">2018-10-26 21:00:25</span></div> <div class="content"><p>php的session默认有效期是24分钟（1440s），如果客户端超过24分钟没有刷新，session就应当会被回收，失效。用户关闭浏览器，会话结束，session也应当失效。但是事实情况往往并非如此！</p> <p>首先谈谈关于session gc的基本设置。 session的生命周期可以通过session.gc_maxlifetime来设置。 php中session的默认存储方式是文件，可以通过php.ini中session.save_handler来设置，使用文件进行存储时，默认的存储位置为/var/lib/php/session(ubuntu系统)，也可通过session.save_path自行修改存储位置。</p> <p>注释：phpini中对于配置session.save_path同时给出这种方式：session.save_path = &quot;N;MODE;/tmp&quot; 其中，N表示多级目录，值为数字。MODE表示创建session文件权限。/tmp表示session存储路径。官方给出如下解释性说明：</p> <p>此指令还有一个可选的 N 参数来决定会话文件分布的目录深度。 例如，设定为 '5;/tmp' 将使创建的会话文件和路径类似于 /tmp/4/b/1/e/3/sess_4b1e384ad74619bd212e236e52a5a174If。 要使用 N 参数，必须在使用前先创建好这些目录。 在 ext/session 目录下有个小的 shell 脚本名叫 mod_files.sh，windows 版本是 mod_files.bat 可以用来做这件事。 此外注意如果使用了 N 参数并且大于 0，那么将不会执行自动垃圾回收，更多信息见 php.ini。 另外如果用了 N 参数，要确保将 session.save_path 的值用双引号 &quot;quotes&quot; 括起来，因为分隔符分号（ ;）在 php.ini 中也是注释符号。 文件储存模块默认使用 mode 600 创建文件。 通过 修改可选参数 MODE 来改变这种默认行为： N;MODE;/path ，其中 MODE 是 mode 的八进制表示。 MODE 设置不影响进程的掩码(umask)。 Caution：使用以上描述的可选目录层级参数 N 时请注意，对于绝大多数站点， 大于1或者2的值会不太合适——因为这需要创建大量的目录：例如，值设置为 3 需要在文件系统上创建 64^3 个目录，将浪费很多空间和 inode。 仅仅在绝对肯定站点足够大时，才可以设置 N 大于2。</p> <p>除此之外，与session有关的还有一个比较重要的，那就是session.cookie_lifetime，这是设置存储phpsessionID所使用的cookie生命周期，默认时间是0，所以用户关闭浏览器，session就失效了，其实是用来存储phpsessionID的cookie失效了！ 那么接下来就简单讨论下session的GC机制。</p> <p>第一种方式，用户可以通过修改php.ini中session.gc_probability和session.gc_divisor来设置php session的回收概率，默认情况下是1和100，也就是说当用户使用session_start()时，会执行这种回收机制，回收概率是1/100。不过，从性能的角度讲，不建议将这个比率设置过大。</p> <p>另一种方式在ubuntu下，通过外部的cron进程来完成gc的回收，可以在/etc/cron.d/php中查看</p> <div class="language-shell extra-class"><pre class="language-text"><code>vi /etc/cron.d/php 
# Look for and purge old sessions every 30 minutes
09,39 * * * * root [ -x /usr/lib/php/sessionclean ] &amp;&amp; if [ ! -d /run/systemd/system ]; then /usr/lib/php/sessionclean; fi
</code></pre></div><p>除此之外，用户也可以通过程序的方式清除session</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">session_destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>对于如何设置一个严格30分钟过期的session，鸟哥有给出完美的答案，可供参考学习。 附上链接地址：<a href="http://www.laruence.com/2012/01/10/2469.html" target="_blank" rel="noopener noreferrer">风雪之隅<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>本文作者：zane<br>
版权声明：本博客所有文章除特别声明外，均采用 CC BY-NC-SA 3.0 许可协议。转载请注明出处！</p></div></div> <!----> <div class="content page-nav"><p class="inner"><span class="prev">
          ← <a href="/blog/PHP%E4%B8%AD%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%BD%93%E6%88%90%E6%95%B0%E7%BB%84%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%80%E4%B8%AA%E5%9D%91.html" class="prev">
            PHP中字符串当成数组处理的一个坑
          </a></span> <span class="next"><a href="/blog/%E4%B8%80%E4%B8%AA%E7%95%99%E8%A8%80%E5%BC%B9%E5%B9%95demo.html">
            一个留言弹幕demo
          </a> →
        </span></p></div></div> <div id="comment-container"><div class="gt-container"><div class="gt-initing"><i class="gt-loader"></i> <p class="gt-initing-text">Gitalking ...</p></div> <!----> <!----> <div><div class="gt-header"><a class="gt-avatar-github"><span class="gt-ico gt-ico-github"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64 524C64 719.602 189.356 885.926 364.113 947.017 387.65799 953 384 936.115 384 924.767L384 847.107C248.118 863.007 242.674 773.052 233.5 758.001 215 726.501 171.5 718.501 184.5 703.501 215.5 687.501 247 707.501 283.5 761.501 309.956 800.642 361.366 794.075 387.658 787.497 393.403 763.997 405.637 743.042 422.353 726.638 281.774 701.609 223 615.67 223 513.5 223 464.053 239.322 418.406 271.465 381.627 251.142 320.928 273.421 269.19 276.337 261.415 334.458 256.131 394.888 302.993 399.549 306.685 432.663 297.835 470.341 293 512.5 293 554.924 293 592.81 297.896 626.075 306.853 637.426 298.219 693.46 258.054 747.5 262.966 750.382 270.652 772.185 321.292 753.058 381.083 785.516 417.956 802 463.809 802 513.5 802 615.874 742.99 701.953 601.803 726.786 625.381 750.003 640 782.295 640 818.008L640 930.653C640.752 939.626 640 948.664978 655.086 948.665 832.344 888.962 960 721.389 960 524 960 276.576 759.424 76 512 76 264.577 76 64 276.576 64 524Z"></path>
</svg>
</span> <!----></span></a> <div class="gt-header-comment"><textarea placeholder="Leave a comment" class="gt-header-textarea"></textarea> <div class="gt-header-preview markdown-body hide"></div> <div class="gt-header-controls"><a href="https://guides.github.com/features/mastering-markdown/" target="_blank" class="gt-header-controls-tip"><span class="gt-ico gt-ico-tip"><span class="gt-svg"><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 366.949535c-16.065554 0-29.982212 13.405016-29.982212 29.879884l0 359.070251c0 16.167882 13.405016 29.879884 29.982212 29.879884 15.963226 0 29.879884-13.405016 29.879884-29.879884L541.879884 396.829419C541.879884 380.763865 528.474868 366.949535 512 366.949535L512 366.949535z"
    p-id="3083"></path>
  <path d="M482.017788 287.645048c0-7.776956 3.274508-15.553912 8.80024-21.181973 5.525732-5.525732 13.302688-8.80024 21.181973-8.80024 7.776956 0 15.553912 3.274508 21.079644 8.80024 5.525732 5.62806 8.80024 13.405016 8.80024 21.181973 0 7.776956-3.274508 15.656241-8.80024 21.181973-5.525732 5.525732-13.405016 8.697911-21.079644 8.697911-7.879285 0-15.656241-3.274508-21.181973-8.697911C485.292295 303.301289 482.017788 295.524333 482.017788 287.645048L482.017788 287.645048z"
    p-id="3084"></path>
  <path d="M512 946.844409c-239.8577 0-434.895573-195.037873-434.895573-434.895573 0-239.8577 195.037873-434.895573 434.895573-434.895573 239.755371 0 434.895573 195.037873 434.895573 434.895573C946.895573 751.806535 751.755371 946.844409 512 946.844409zM512 126.17088c-212.740682 0-385.880284 173.037274-385.880284 385.777955 0 212.740682 173.037274 385.777955 385.880284 385.777955 212.740682 0 385.777955-173.037274 385.777955-385.777955C897.777955 299.208154 724.740682 126.17088 512 126.17088z"
    p-id="3085"></path>
</svg>
</span> <span class="gt-ico-text">Markdown is supported</span></span></a> <!----> <button class="gt-btn gt-btn-preview"><span class="gt-btn-text">Preview</span> <!----></button> <button class="gt-btn gt-btn-login"><span class="gt-btn-text">Login with GitHub</span> <!----></button></div></div></div> <div class="gt-comments"><span></span> <p class="gt-comments-null">
                Be the first guy leaving a comment!
            </p> <!----></div></div></div></div></div> <!----></div> <div class="tool-group"><!----></div></div> <!----></div> <div class="background-mask" style="background:url(&quot;#e6ecf0&quot;) no-repeat fixed;"></div></div></div>
    <script src="/assets/js/13.2935f7b1.js" defer></script><script src="/assets/js/app.5f87c6e8.js" defer></script>
  </body>
</html>
